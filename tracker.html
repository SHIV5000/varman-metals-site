<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Task Tracker Pro - MR. SHIV SURI</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet" />
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800&display=swap" rel="stylesheet" />
  <style>
    html { scroll-behavior: smooth; }
    body { font-family: Inter, sans-serif; background: #f8fafc; color: #0f172a; }
    
    /* Marquee - White Background */
    .marquee-container { background: #ffffff; color: #ef4444; padding: 10px 0; overflow: hidden; border-bottom: 2px solid #e2e8f0; display: none; }
    .marquee-content { display: inline-block; animation: marquee 15s linear infinite; font-weight: 800; font-size: 16px; text-transform: uppercase; }
    @keyframes marquee { 0% { transform: translateX(100%); } 100% { transform: translateX(-100%); } }

    /* Task Card Styles */
    .task-card { background: white; border-radius: 20px; border: 1px solid #e2e8f0; transition: all 0.3s; margin-bottom: 1.5rem; }
    .status-progress { border-left: 12px solid #f97316; }
    .status-completed { border-left: 12px solid #22c55e; }
    .status-started { border-left: 12px solid #3b82f6; }
    
    .urgency-urgent { border: 2px solid #ef4444 !important; background: #fff7ed !important; animation: pulse-border 2s infinite; }
    @keyframes pulse-border { 0% { border-color: #ef4444; } 50% { border-color: #f97316; } 100% { border-color: #ef4444; } }

    .fire-badge { background: #ef4444; color: white; padding: 4px 12px; border-radius: 99px; font-size: 12px; font-weight: 900; animation: bounce 1s infinite; }
    @keyframes bounce { 0%, 100% { transform: translateY(0); } 50% { transform: translateY(-3px); } }

    .subtask-box { background: #ffffff; border: 1px solid #f1f5f9; border-radius: 12px; padding: 16px; margin-top: 10px; box-shadow: 0 2px 4px rgba(0,0,0,0.02); }
    .subtask-text { font-size: 16px; font-weight: 600; color: #1e293b; line-height: 1.5; }
    
    .field-by { color: #2563eb; margin-right: 15px; } 
    .field-date { color: #64748b; margin-right: 15px; } 
    .field-via { color: #7c3aed; } 

    .input-field { width: 100%; border: 1px solid #cbd5e1; border-radius: 12px; padding: 12px; font-size: 15px; }
    
    @media print { 
        .no-print { display: none !important; } 
        body { background: white; padding: 0; }
        .task-card { border: 1px solid #ddd !important; break-inside: avoid; }
        .container-main { grid-template-columns: 1fr !important; }
    }
  </style>
</head>
<body class="pb-20">

  <nav class="bg-white border-b px-8 py-5 flex flex-col lg:flex-row justify-between items-center sticky top-0 z-50 shadow-sm no-print">
    <div class="flex flex-col gap-2">
      <div class="flex items-center gap-4">
        <div class="bg-blue-900 text-white p-3 rounded-2xl"><i class="fas fa-tasks fa-lg"></i></div>
        <h1 class="text-2xl font-black text-blue-900 tracking-tight">TASK TRACKER <span class="text-slate-300 font-light">| SHIV SURI</span></h1>
      </div>
      
      <div class="flex items-center gap-6 ml-16">
        <div class="flex gap-4 text-xs font-black uppercase tracking-wider">
          <span id="stat-completed" class="text-green-600 bg-green-50 px-2 py-1 rounded">âœ… 0 Completed</span>
          <span id="stat-progress" class="text-orange-600 bg-orange-50 px-2 py-1 rounded">ðŸ‘· 0 In Progress</span>
        </div>
        <button onclick="window.print()" class="text-[10px] font-bold bg-slate-800 text-white px-3 py-1 rounded-lg hover:bg-slate-700 transition-colors flex items-center gap-2">
            <i class="fas fa-print"></i> PRINT REPORT
        </button>
      </div>
    </div>

    <div class="flex flex-wrap gap-3 mt-4 lg:mt-0 bg-slate-50 p-2 rounded-2xl border">
      <select id="filterStatus" onchange="App.render()" class="bg-white border p-2 rounded-xl text-xs font-bold">
        <option value="">All Status</option>
        <option value="Started">Started</option>
        <option value="Progress">In Progress</option>
        <option value="Completed">Completed</option>
      </select>
      <select id="filterDirector" onchange="App.render()" class="bg-white border p-2 rounded-xl text-xs font-bold">
        <option value="">All Roles</option>
        <option>Director Acad & Sys</option>
        <option>Principal</option>
        <option>Head Admin</option>
        <option>Management</option>
        <option>Acad Coord</option>
        <option>Other</option>
      </select>
      <input type="date" id="filterDate" onchange="App.render()" class="bg-white border p-2 rounded-xl text-xs font-bold">
    </div>
  </nav>

  <div id="marqueeContainer" class="marquee-container no-print">
    <div id="marquee" class="marquee-content"></div>
  </div>

  <div class="max-w-[1500px] mx-auto px-6 mt-8 grid grid-cols-1 lg:grid-cols-12 gap-10 container-main">
    <aside class="lg:col-span-4 no-print">
      <div class="bg-white p-8 rounded-3xl border shadow-xl sticky top-40">
        <h2 id="formTitle" class="font-black text-xl mb-6 text-slate-700 uppercase tracking-widest">Master Config</h2>
        <form id="masterForm" class="space-y-4">
          <input type="hidden" id="mId">
          <input type="text" id="mTitle" placeholder="Task Headline" required class="input-field">
          <textarea id="mDesc" placeholder="Detailed Instructions..." class="input-field" rows="2"></textarea>
          
          <div class="grid grid-cols-1 gap-4">
            <select id="mSource" class="input-field">
              <option>Director Acad & Sys</option>
              <option>Principal</option>
              <option>Head Admin</option>
              <option>Management</option>
              <option>Acad Coord</option>
              <option>Other</option>
            </select>
            <input type="text" id="mAssignee" placeholder="Assigned To..." class="input-field">
          </div>

          <div class="grid grid-cols-2 gap-4">
            <select id="mStatus" class="input-field font-bold">
              <option value="Started">STARTED</option>
              <option value="Progress">IN PROGRESS</option>
              <option value="Completed">COMPLETED</option>
            </select>
            <input type="date" id="mDeadline" required class="input-field">
          </div>
          
          <button type="submit" id="mSubmit" class="w-full bg-blue-900 text-white font-black py-4 rounded-2xl shadow-lg hover:bg-blue-800 transition-all">SAVE MASTER TASK</button>
        </form>
      </div>
    </aside>

    <main class="lg:col-span-8 space-y-6" id="taskBody"></main>
  </div>

  <div id="subModal" class="fixed inset-0 bg-slate-900/60 hidden flex items-center justify-center z-[100] backdrop-blur-sm no-print">
    <div class="bg-white p-8 rounded-3xl w-full max-w-lg shadow-2xl mx-4">
      <h3 id="subModalTitle" class="font-black text-2xl mb-6">Add Update Log</h3>
      <form id="subForm" class="space-y-4">
        <input type="hidden" id="subParentId">
        <input type="hidden" id="subId">
        <textarea id="subNote" placeholder="Write the update here..." required class="input-field h-32"></textarea>
        
        <div class="grid grid-cols-2 gap-4">
            <input type="text" id="subAssignee" placeholder="Your Name" required class="input-field">
            <input type="date" id="subDate" required class="input-field">
        </div>

        <select id="subMode" class="input-field">
            <option value="WhatsApp">WhatsApp</option>
            <option value="Intercom">Intercom</option>
            <option value="Mobile">Mobile</option>
            <option value="Email">Email</option>
            <option value="Verbal">Verbal</option>
            <option value="Written">Written</option>
            <option value="Slack">Slack</option>
        </select>

        <div class="flex gap-4 mt-4">
          <button type="button" onclick="App.closeSubModal()" class="flex-1 py-4 font-bold text-slate-400">Cancel</button>
          <button type="submit" class="flex-2 bg-blue-900 text-white font-black px-10 py-4 rounded-2xl shadow-xl">POST UPDATE</button>
        </div>
      </form>
    </div>
  </div>

  <script>
    const App = {
      URL: "https://script.google.com/macros/s/AKfycbxmXjkC_wJ58wxvsLPB2ijsGZViykVuPexxNavdbXyc7HF9bCmqFgWrfFQv3f6EVbVN/exec", 
      data: [],

      init() {
        document.getElementById("masterForm").onsubmit = (e) => this.saveMaster(e);
        document.getElementById("subForm").onsubmit = (e) => this.saveSub(e);
        this.fetch();
      },

      async fetch() {
        try {
            const res = await fetch(this.URL);
            const json = await res.json();
            this.data = Array.isArray(json) ? json : [];
            this.render();
        } catch(e) { console.error("Fetch error", e); }
      },

      formatDate(iso) {
        if (!iso) return "N/A";
        const d = new Date(iso);
        return d.toLocaleDateString("en-GB", { day: '2-digit', month: 'short', year: 'numeric' });
      },

      render() {
        const body = document.getElementById("taskBody");
        const fStatus = document.getElementById("filterStatus").value;
        const fDirector = document.getElementById("filterDirector").value;
        const fDate = document.getElementById("filterDate").value;
        const todayStr = new Date().toISOString().split('T')[0];

        let filtered = [...this.data];
        filtered.sort((a, b) => new Date(a.deadline) - new Date(b.deadline));

        if (fStatus) filtered = filtered.filter(t => t.status === fStatus);
        if (fDirector) filtered = filtered.filter(t => t.source === fDirector);
        if (fDate) filtered = filtered.filter(t => t.deadline === fDate);

        // Update Counts
        const completedCount = this.data.filter(t => t.status === 'Completed').length;
        const progressCount = this.data.filter(t => t.status === 'Progress').length;
        document.getElementById('stat-completed').innerText = `âœ… ${completedCount} Completed`;
        document.getElementById('stat-progress').innerText = `ðŸ‘· ${progressCount} In Progress`;

        // Marquee Logic
        const marqueeEl = document.getElementById("marquee");
        const marqueeContainer = document.getElementById("marqueeContainer");
        const todayTasks = filtered.filter(t => t.deadline === todayStr && t.status !== 'Completed');

        if (todayTasks.length > 0) {
          marqueeContainer.style.display = "block";
          marqueeEl.innerHTML = todayTasks.map(t => `<span class="mr-20">ðŸš¨ EVENT DUE TODAY: ${t.title} ðŸš¨</span>`).join("");
        } else {
          marqueeContainer.style.display = "none";
        }

        body.innerHTML = "";
        filtered.forEach(t => {
          const isDueToday = (t.deadline === todayStr && t.status !== 'Completed');
          const card = document.createElement("div");
          card.className = `task-card p-8 status-${t.status.toLowerCase()} ${isDueToday ? 'urgency-urgent' : ''}`;
          
          card.innerHTML = `
            <div class="flex justify-between items-start">
              <div onclick="App.editMaster('${t.id}')" class="cursor-pointer flex-1">
                <div class="flex items-center gap-3 mb-4">
                   <span class="text-[10px] font-black uppercase px-3 py-1 bg-slate-100 rounded-full border">${t.status}</span>
                   ${isDueToday ? '<span class="fire-badge no-print"><i class="fas fa-fire"></i> DUE TODAY</span>' : ''}
                </div>
                <h3 class="text-2xl font-black text-slate-800">${t.title} <span class="text-slate-300 mx-3">|</span> <span class="text-blue-600 uppercase text-lg">${this.formatDate(t.deadline)}</span></h3>
                <p class="text-slate-500 mt-2 font-medium">${t.name || ''}</p>
                <div class="mt-4 flex gap-6 text-[11px] font-black text-slate-400 uppercase tracking-widest">
                  <span class="text-blue-900"><i class="fas fa-id-badge mr-2"></i>FROM: ${t.source}</span>
                  <span class="text-orange-600"><i class="fas fa-user-circle mr-2"></i>ASSIGNED TO: ${t.assignee}</span>
                </div>
              </div>
              <button onclick="App.openSubModal('${t.id}')" class="bg-blue-900 text-white h-12 w-12 flex items-center justify-center rounded-xl shadow hover:scale-110 transition-transform no-print">
                <i class="fas fa-plus"></i>
              </button>
            </div>
            <div class="mt-6 space-y-3">
              ${t.subTasks.map(s => `
                <div ondblclick="App.editSub('${t.id}', '${s.id}')" class="subtask-box">
                  <p class="subtask-text">${s.text}</p>
                  <div class="mt-2 font-black uppercase text-[10px] flex items-center">
                    <span class="field-by">BY: ${s.assignee}</span>
                    <span class="field-date">${this.formatDate(s.date)}</span>
                    <span class="field-via">${s.mode}</span>
                  </div>
                </div>
              `).join("")}
            </div>
          `;
          body.appendChild(card);
        });
      },

      openSubModal(parentId) {
        document.getElementById("subParentId").value = parentId;
        document.getElementById("subId").value = "";
        document.getElementById("subNote").value = "";
        document.getElementById("subAssignee").value = "";
        document.getElementById("subDate").value = new Date().toISOString().split('T')[0];
        document.getElementById("subModalTitle").innerText = "New Log Entry";
        document.getElementById("subModal").classList.remove("hidden");
      },

      editSub(parentId, subId) {
        const m = this.data.find(x => x.id === parentId);
        const s = m.subTasks.find(x => x.id === subId);
        document.getElementById("subParentId").value = parentId;
        document.getElementById("subId").value = s.id;
        document.getElementById("subNote").value = s.text;
        document.getElementById("subAssignee").value = s.assignee;
        document.getElementById("subMode").value = s.mode;
        document.getElementById("subDate").value = s.date;
        document.getElementById("subModalTitle").innerText = "Edit Log Entry";
        document.getElementById("subModal").classList.remove("hidden");
      },

      closeSubModal() { document.getElementById("subModal").classList.add("hidden"); },

      async saveSub(e) {
        e.preventDefault();
        const payload = {
          action: document.getElementById("subId").value ? "editSub" : "addSub",
          id: document.getElementById("subId").value,
          parentId: document.getElementById("subParentId").value,
          text: document.getElementById("subNote").value,
          assignee: document.getElementById("subAssignee").value,
          mode: document.getElementById("subMode").value,
          date: document.getElementById("subDate").value
        };
        await fetch(this.URL, { method: "POST", body: JSON.stringify(payload) });
        location.reload();
      },

      editMaster(id) {
        const t = this.data.find(x => x.id === id);
        document.getElementById("mId").value = t.id;
        document.getElementById("mTitle").value = t.title;
        document.getElementById("mDesc").value = t.name;
        document.getElementById("mSource").value = t.source;
        document.getElementById("mAssignee").value = t.assignee;
        document.getElementById("mStatus").value = t.status;
        document.getElementById("mDeadline").value = t.deadline;
        document.getElementById("formTitle").innerText = "MODIFICATION MODE";
        window.scrollTo(0,0);
      },

      async saveMaster(e) {
        e.preventDefault();
        const payload = {
          action: document.getElementById("mId").value ? "editMaster" : "addMaster",
          id: document.getElementById("mId").value,
          title: document.getElementById("mTitle").value,
          name: document.getElementById("mDesc").value,
          source: document.getElementById("mSource").value,
          assignee: document.getElementById("mAssignee").value,
          status: document.getElementById("mStatus").value,
          deadline: document.getElementById("mDeadline").value
        };
        await fetch(this.URL, { method: "POST", body: JSON.stringify(payload) });
        location.reload();
      }
    };
    App.init();
  </script>
</body>
</html>
