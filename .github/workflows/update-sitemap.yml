name: Complete Auto-update Sitemap

# Trigger the workflow on ANY push to the main branch
on:
  push:
    branches: [main]

permissions:
  contents: write

jobs:
  generate-sitemap:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repo
        uses: actions/checkout@v3
        with:
          fetch-depth: 0 

      - name: Setup Node.js
        uses: actions/setup-node@v3
        with:
          node-version: '18'

      - name: Install Dependencies üì¶
        # Install the reliable 'sitemap' package and 'glob' for dynamic file finding
        run: npm install sitemap glob

      - name: Generate Dynamic Sitemap üõ†Ô∏è
        # This script runs Node.js code to find all files and build the sitemap
        run: |
          node -e "
            const { SitemapStream, streamToPromise } = require('sitemap');
            const { createWriteStream } = require('fs');
            const { glob } = require('glob');
            const path = require('path');
            
            const HOSTNAME = 'https://www.varmanmetals.in';
            const SITEMAP_FILE = 'sitemap.xml';

            async function generateSitemap() {
              const files = await glob('**/*.html', { ignore: ['node_modules/**', '404.html', '_site/**'] });
              const sitemap = new SitemapStream({ hostname: HOSTNAME });
              const writeStream = createWriteStream(path.resolve('./', SITEMAP_FILE));
              sitemap.pipe(writeStream);

              // Map files to sitemap links
              files.forEach(file => {
                // Convert file path to URL path (e.g., 'index.html' -> '/', 'blog/post.html' -> '/blog/post.html')
                let urlPath = file === 'index.html' ? '/' : \`/\${file}\`;
                
                // Determine priority
                let priority = 0.8;
                if (urlPath === '/') {
                  priority = 1.0; // Highest priority for the homepage
                } else if (urlPath.startsWith('/blog/')) {
                  priority = 0.7; // Slightly lower for blog posts
                }
                
                sitemap.write({ 
                  url: urlPath, 
                  changefreq: 'daily', 
                  priority: priority, 
                  lastmod: new Date() 
                });
              });
              
              sitemap.end();
              await streamToPromise(sitemap);
              console.log(\`\${SITEMAP_FILE} successfully generated.\`);
            }
            
            generateSitemap().catch(console.error);
          "
        
      - name: Commit and Push updated sitemap (and robots.txt) ‚¨ÜÔ∏è
        run: |
          git config --global user.name "github-actions[bot]"
          git config --global user.email "github-actions[bot]@users.noreply.github.com"
          
          git add sitemap.xml robots.txt
          
          if git diff --cached --exit-code; then
              echo "No changes to commit. Nothing to push."
          else
              git commit -m "Auto-update sitemap.xml (Dynamic Generation)"
              git push origin main
              echo "Sitemap.xml and robots.txt updated and pushed."
          fi
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          
      - name: Ping Search Engines for Sitemap Update üîî
        if: success()
        run: |
          echo "Pinging Google and Bing to request a crawl of the new sitemap."
          
          curl -s "http://www.google.com/ping?sitemap=https://www.varmanmetals.in/sitemap.xml"
          echo "Google Ping Sent."
          
          curl -s "http://www.bing.com/ping?sitemap=https://www.varmanmetals.in/sitemap.xml"
          echo "Bing Ping Sent."
